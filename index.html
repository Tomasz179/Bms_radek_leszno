<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>JK-BMS ‚Äì pe≈Çny podglƒÖd</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <style>
    :root{ --maxw:1200px } *{box-sizing:border-box}
    body{font-family:Arial,system-ui,Segoe UI; background:#f6f7fb; margin:0; padding:16px; color:#111}
    h1{ text-align:center; margin:8px 0 14px; font-size:22px }
    .wrap{ max-width:var(--maxw); margin:0 auto }
    .status{ text-align:center; font-size:12px; color:#555; margin-bottom:12px }
    .section{ margin:16px 0 10px; font-weight:700; color:#444; border-left:4px solid #0d6efd; padding-left:8px }
    .grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(230px,1fr)); gap:12px }
    .cells{ display:grid; grid-template-columns:repeat(auto-fit,minmax(120px,1fr)); gap:10px }
    .card{ background:#fff; border-radius:12px; padding:14px; box-shadow:0 3px 12px rgba(0,0,0,.06) }
    .title{ font-weight:700; margin-bottom:6px }
    .val{ font-size:20px; font-weight:700 }
    .unit{ color:#666; margin-left:4px; font-weight:500 }
    .row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:8px }
    .badge{ display:inline-block; padding:4px 8px; border-radius:999px; font-size:12px; font-weight:700; }
    .on{ background:#e9fff4; color:#0a7; border:1px solid #9cdebf }
    .off{ background:#f3f4f6; color:#444; border:1px solid #d0d5dd }
    .text{ font-size:13px; color:#333; white-space:pre-wrap; word-break:break-word }
    .cell{ background:#fff; border:1px solid #e5e7eb; border-radius:10px; padding:10px; box-shadow:0 2px 8px rgba(0,0,0,.04) }
    .cell .hdr{ display:flex; justify-content:space-between; align-items:center; margin-bottom:6px; font-size:12px; color:#666 }

    /* Has≈Ço */
    #lock{ position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:#0b0f1a; z-index:9999 }
    #lock .box{ background:#fff; padding:18px; border-radius:12px; width:320px; text-align:center; box-shadow:0 10px 30px rgba(0,0,0,.25) }
    #lock input,#lock button{ width:100%; padding:10px; border-radius:8px }
    #lock input{ border:1px solid #ddd; margin:8px 0 }
    #lock button{ border:none; background:#0d6efd; color:#fff; cursor:pointer }
    #msg{ color:#c00; min-height:1.2em; font-size:13px }
  </style>
</head>
<body>
  <!-- BLOKADA -->
  <div id="lock">
    <div class="box">
      <h3>üîê JK-BMS ‚Äì dostƒôp</h3>
      <input id="pwd" type="password" placeholder="Has≈Ço" autocomplete="current-password" />
      <button id="unlock">Odblokuj</button>
      <div id="msg"></div>
    </div>
  </div>

  <!-- APP -->
  <div id="app" style="display:none">
    <div class="wrap">
      <h1>üîã JK-BMS ‚Äì pe≈Çny podglƒÖd (bms0 + bms1)</h1>
      <div class="status">MQTT: <b id="mqtt">inicjalizacja‚Ä¶</b></div>

      <div class="section">BMS 0 ‚Äì podstawowe</div>
      <div id="bms0_basic" class="grid"></div>

      <div class="section">BMS 0 ‚Äì moce/prƒÖdy/pojemno≈õci</div>
      <div id="bms0_power" class="grid"></div>

      <div class="section">BMS 0 ‚Äì stany</div>
      <div id="bms0_flags" class="grid"></div>

      <div class="section">BMS 0 ‚Äì cele (16√ó)</div>
      <div id="bms0_cells" class="cells"></div>

      <div class="section">BMS 1 ‚Äì podstawowe</div>
      <div id="bms1_basic" class="grid"></div>

      <div class="section">BMS 1 ‚Äì moce/prƒÖdy/pojemno≈õci</div>
      <div id="bms1_power" class="grid"></div>

      <div class="section">BMS 1 ‚Äì stany</div>
      <div id="bms1_flags" class="grid"></div>

      <div class="section">BMS 1 ‚Äì cele (16√ó)</div>
      <div id="bms1_cells" class="cells"></div>

      <div class="section">Komunikaty b≈Çƒôd√≥w</div>
      <div id="texts" class="grid"></div>
    </div>
  </div>

<script>
/* ===================== USTAWIENIA ===================== */
const SETTINGS = {
  PASSWORD: "tomek1425",
  MQTT_WSS_URL: "wss://broker.hivemq.com:8884/mqtt",
  PREFIX: "bms_radek_leszno",
  DEV: "jk-bms-radek-leszno"
};

/* ===================== GENERATORY TEMAT√ìW ===================== */
const topicS = (bms, key) => `${SETTINGS.PREFIX}/sensor/${SETTINGS.DEV}_${bms}_${key}/state`;
const topicB = (bms, key) => `${SETTINGS.PREFIX}/binary_sensor/${SETTINGS.DEV}_${bms}_${key}/state`;
const topicT = (bms, key) => `${SETTINGS.PREFIX}/text_sensor/${SETTINGS.DEV}_${bms}_${key}/state`;

/* ===================== DEFINICJE KAFELK√ìW ===================== */
const SENSORS_BASIC = [
  // label, key, unit, decimals
  ['Napiƒôcie ca≈Çkowite', 'total_voltage', 'V', 2],
  ['PrƒÖd',                'current',       'A', 2],
  ['SOC',                 'state_of_charge','%',1],
  ['Temp. czujnik 1',     'temperature_sensor_1','¬∞C',1],
  ['Temp. MOSFET',        'power_tube_temperature','¬∞C',1],
  ['Czas pracy (s)',      'total_runtime',  '', 0],
  ['Bitmask b≈Çƒôd√≥w',      'errors_bitmask', '', 0],
  ['Emergency countdown', 'emergency_time_countdown','s',0],
];

const SENSORS_POWER = [
  ['Moc',                        'power',                     'W', 0],
  ['Moc ≈Çadowania',              'charging_power',            'W', 0],
  ['Moc roz≈Çadowania',           'discharging_power',         'W', 0],
  ['PrƒÖd grzania',               'heating_current',           'A', 2],
  ['PrƒÖd balansowania',          'balancing_current',         'A', 2],
  ['Poj. pozosta≈Ça',             'capacity_remaining',        'Ah',1],
  ['Poj. ustawiona ca≈Çkowita',   'total_battery_capacity_setting','Ah',1],
  ['Cykle ≈Çadowania',            'charging_cycles',           '',  0],
  ['Poj. cykli ≈ÇƒÖcznie',         'total_charging_cycle_capacity','Ah',1],
];

const FLAGS = [
  ['≈Åadowanie',    'charging'],
  ['Roz≈Çadowanie', 'discharging'],
  ['Balansowanie', 'balancing'],
  ['Online',       'online_status'],
];

/* ===================== BLOKADA HAS≈ÅA ===================== */
(function(){
  const lock=document.getElementById('lock'), app=document.getElementById('app');
  const pwd=document.getElementById('pwd'), msg=document.getElementById('msg');
  const ok=()=>{ lock.style.display='none'; app.style.display='block'; initApp(); };
  document.getElementById('unlock').onclick=()=> (pwd.value||'').trim()===SETTINGS.PASSWORD ? ok() : (msg.textContent='‚ùå Z≈Çe has≈Ço');
  pwd.addEventListener('keydown',e=>{ if(e.key==='Enter') document.getElementById('unlock').click(); });
  const qp=new URLSearchParams(location.search); if(qp.get('pass')){ pwd.value=qp.get('pass'); document.getElementById('unlock').click(); }
})();

/* ===================== APP ===================== */
function initApp(){
  const elMqtt=document.getElementById('mqtt');
  const holders = {};
  const nodes = {}; // id -> {cfg, el}
  const holder = sel => holders[sel] ?? (holders[sel]=document.querySelector(sel));

  function addSensor(box, id, label, unit, decimals){
    const card=document.createElement('div'); card.className='card';
    card.innerHTML=`<div class="title">${label}</div><div class="val"><span id="${id}">‚Äî</span>${unit?`<span class="unit">${unit}</span>`:''}</div>`;
    holder(box).appendChild(card);
    nodes[id]={cfg:{type:'sensor', decimals}, el:document.getElementById(id)};
  }
  function addFlag(box, id, label){
    const card=document.createElement('div'); card.className='card';
    card.innerHTML=`<div class="title">${label}</div><div class="row"><span id="${id}" class="badge off">OFF</span></div>`;
    holder(box).appendChild(card);
    nodes[id]={cfg:{type:'binary'}, el:document.getElementById(id)};
  }
  function addCell(box, id, label){
    const cell=document.createElement('div'); cell.className='cell';
    cell.innerHTML=`<div class="hdr"><span>${label}</span></div><div class="val"><span id="${id}">‚Äî</span><span class="unit">V</span></div>`;
    holder(box).appendChild(cell);
    nodes[id]={cfg:{type:'sensor', decimals:3}, el:document.getElementById(id)};
  }
  function addText(box, id, label){
    const card=document.createElement('div'); card.className='card';
    card.innerHTML=`<div class="title">${label}</div><div id="${id}" class="text">‚Äî</div>`;
    holder(box).appendChild(card);
    nodes[id]={cfg:{type:'text'}, el:document.getElementById(id)};
  }

  // ===== Render BMS0
  for(const [label,key,unit,dec] of SENSORS_BASIC) addSensor('#bms0_basic', 'b0_'+key, label, unit, dec);
  for(const [label,key,unit,dec] of SENSORS_POWER) addSensor('#bms0_power', 'b0_'+key, label, unit, dec);
  for(const [label,key] of FLAGS) addFlag('#bms0_flags', 'b0_'+key, label);
  for(let i=1;i<=16;i++) addCell('#bms0_cells', `c0_${i}`, `C${i}`);

  // ===== Render BMS1
  for(const [label,key,unit,dec] of SENSORS_BASIC) addSensor('#bms1_basic', 'b1_'+key, label, unit, dec);
  for(const [label,key,unit,dec] of SENSORS_POWER) addSensor('#bms1_power', 'b1_'+key, label, unit, dec);
  for(const [label,key] of FLAGS) addFlag('#bms1_flags', 'b1_'+key, label);
  for(let i=1;i<=16;i++) addCell('#bms1_cells', `c1_${i}`, `C${i}`);

  // Teksty b≈Çƒôd√≥w
  addText('#texts', 'b0_errors', 'BMS 0 b≈Çƒôdy');
  addText('#texts', 'b1_errors', 'BMS 1 b≈Çƒôdy');

  // ===== Subskrypcje MQTT
  const subs = [];

  // helpery
  const addSub = (topic,id) => subs.push([topic,id]);
  const mapNum = v => { const m=String(v).match(/-?\d+(?:[.,]\d+)?/); return m?parseFloat(m[0].replace(',','.')):NaN; };
  const fmt = (n,d=1)=> isNaN(n)?'‚Äî':(Math.round(n*10**d)/10**d).toFixed(d).replace('.',',');

  // BMS0 numeryczne / binarne
  for(const [,key] of [...SENSORS_BASIC, ...SENSORS_POWER]){
    addSub(topicS('bms0', key), 'b0_'+key);
  }
  for(const [,key] of FLAGS){
    addSub(topicB('bms0', key), 'b0_'+key);
  }
  for(let i=1;i<=16;i++) addSub(topicS('bms0', `cell_voltage_${i}`), `c0_${i}`);
  addSub(topicT('bms0','errors'), 'b0_errors');

  // BMS1 numeryczne / binarne
  for(const [,key] of [...SENSORS_BASIC, ...SENSORS_POWER]){
    addSub(topicS('bms1', key), 'b1_'+key);
  }
  for(const [,key] of FLAGS){
    addSub(topicB('bms1', key), 'b1_'+key);
  }
  for(let i=1;i<=16;i++) addSub(topicS('bms1', `cell_voltage_${i}`), `c1_${i}`);
  addSub(topicT('bms1','errors'), 'b1_errors');

  // MQTT klient
  const client=mqtt.connect(SETTINGS.MQTT_WSS_URL,{clientId:'bms_'+Math.random().toString(16).slice(2)});
  client.on('connect',()=>{
    elMqtt.textContent='po≈ÇƒÖczono';
    subs.forEach(([tp])=>client.subscribe(tp));
  });
  client.on('reconnect',()=> elMqtt.textContent='ponowne ≈ÇƒÖczenie‚Ä¶');
  client.on('close',()=> elMqtt.textContent='roz≈ÇƒÖczono');
  client.on('error',e=>{ elMqtt.textContent='b≈ÇƒÖd MQTT (konsola)'; console.error(e); });

  client.on('message',(topic,payload)=>{
    const val = payload.toString();
    const sub = subs.find(s=>s[0]===topic);
    if(!sub) return;
    const id = sub[1];
    const node = nodes[id];
    if(!node) return;

    if(node.cfg.type==='text'){
      node.el.textContent = val && val!=='unknown' ? val : '‚Äî';
      return;
    }
    if(node.cfg.type==='binary'){
      const s=String(val).trim().toUpperCase();
      const on = (s==='ON' || s==='TRUE' || s==='1');
      node.el.textContent = on ? 'ON' : 'OFF';
      node.el.classList.toggle('on', on);
      node.el.classList.toggle('off', !on);
      return;
    }
    // sensor (liczba)
    const n = mapNum(val);
    node.el.textContent = fmt(n, node.cfg.decimals ?? 1);
  });
}
</script>
</body>
</html>
