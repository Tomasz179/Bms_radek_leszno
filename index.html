<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>JK-BMS ‚Äì Napiƒôcia Cel (32)</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <style>
    :root{ --maxw:1200px } *{box-sizing:border-box}
    body{font-family:Arial,system-ui,Segoe UI; background:#f6f7fb; margin:0; padding:16px; color:#111}
    h1{ text-align:center; margin:8px 0 14px; font-size:22px }
    .wrap{ max-width:var(--maxw); margin:0 auto }
    .status{ text-align:center; font-size:12px; color:#555; margin-bottom:12px }
    .section{ margin:16px 0 10px; font-weight:700; color:#444; border-left:4px solid #0d6efd; padding-left:8px }
    .cells{ display:grid; grid-template-columns:repeat(auto-fit,minmax(120px,1fr)); gap:10px }
    .cell{ background:#fff; border:1px solid #e5e7eb; border-radius:10px; padding:10px; box-shadow:0 2px 8px rgba(0,0,0,.04) }
    .cell .hdr{ display:flex; justify-content:space-between; align-items:center; margin-bottom:6px; font-size:12px; color:#666 }
    .val{ font-size:20px; font-weight:700 }
    .unit{ color:#666; margin-left:4px; font-weight:500 }

    /* Has≈Ço */
    #lock{ position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:#0b0f1a; z-index:9999 }
    #lock .box{ background:#fff; padding:18px; border-radius:12px; width:320px; text-align:center; box-shadow:0 10px 30px rgba(0,0,0,.25) }
    #lock input,#lock button{ width:100%; padding:10px; border-radius:8px }
    #lock input{ border:1px solid #ddd; margin:8px 0 }
    #lock button{ border:none; background:#0d6efd; color:#fff; cursor:pointer }
    #msg{ color:#c00; min-height:1.2em; font-size:13px }
  </style>
</head>
<body>
  <!-- BLOKADA -->
  <div id="lock">
    <div class="box">
      <h3>üîê JK-BMS ‚Äì napiƒôcia cel</h3>
      <input id="pwd" type="password" placeholder="Has≈Ço" autocomplete="current-password" />
      <button id="unlock">Odblokuj</button>
      <div id="msg"></div>
    </div>
  </div>

  <!-- APP -->
  <div id="app" style="display:none">
    <div class="wrap">
      <h1>üîã Napiƒôcia cel (BMS0 + BMS1)</h1>
      <div class="status">MQTT: <b id="mqtt">inicjalizacja‚Ä¶</b></div>

      <div class="section">BMS 0 ‚Äì 16 cel</div>
      <div id="cells0" class="cells"></div>

      <div class="section">BMS 1 ‚Äì 16 cel</div>
      <div id="cells1" class="cells"></div>
    </div>
  </div>

<script>
/* ===================== USTAWIENIA ===================== */
const SETTINGS = {
  PASSWORD: "tomek1425",
  MQTT_WSS_URL: "wss://broker.hivemq.com:8884/mqtt",
  PREFIX: "bms_radek_leszno",
  DEV: "jk-bms-radek-leszno" // z YAML
};

/* ===================== TEMATY MQTT ===================== */
const topicCell = (bms, idx) => `${SETTINGS.PREFIX}/sensor/${SETTINGS.DEV}_${bms}_cell_voltage_${idx}/state`;

/* ===================== BLOKADA HAS≈ÅA ===================== */
(function(){
  const lock=document.getElementById('lock'), app=document.getElementById('app');
  const pwd=document.getElementById('pwd'), msg=document.getElementById('msg');
  const ok=()=>{ lock.style.display='none'; app.style.display='block'; initApp(); };
  document.getElementById('unlock').onclick=()=> (pwd.value||'').trim()===SETTINGS.PASSWORD ? ok() : (msg.textContent='‚ùå Z≈Çe has≈Ço');
  pwd.addEventListener('keydown',e=>{ if(e.key==='Enter') document.getElementById('unlock').click(); });
  const qp=new URLSearchParams(location.search); if(qp.get('pass')){ pwd.value=qp.get('pass'); document.getElementById('unlock').click(); }
})();

/* ===================== APP ===================== */
function initApp(){
  const elMqtt=document.getElementById('mqtt');
  const cells0=document.getElementById('cells0');
  const cells1=document.getElementById('cells1');

  // render 32 kafelki
  const nodes = {}; // id -> {el}
  function makeCell(container, id, label){
    const div=document.createElement('div'); div.className='cell';
    div.innerHTML = `<div class="hdr"><span>${label}</span></div>
                     <div class="val"><span id="${id}">‚Äî</span><span class="unit">V</span></div>`;
    container.appendChild(div);
    nodes[id] = { el: document.getElementById(id) };
  }
  for(let i=1;i<=16;i++) makeCell(cells0, `c0_${i}`, `C${i}`);
  for(let i=1;i<=16;i++) makeCell(cells1, `c1_${i}`, `C${i}`);

  // map: topic -> nodeId
  const topicMap = {};
  for(let i=1;i<=16;i++) topicMap[topicCell('bms0', i)] = `c0_${i}`;
  for(let i=1;i<=16;i++) topicMap[topicCell('bms1', i)] = `c1_${i}`;

  // helpers
  const parseNum=v=>{ const m=String(v).match(/-?\d+(?:[.,]\d+)?/); return m?parseFloat(m[0].replace(',','.')):NaN; };
  const fmt=(n,d=3)=> isNaN(n)?'‚Äî':(Math.round(n*10**d)/10**d).toFixed(d).replace('.',',');

  // MQTT client
  const client=mqtt.connect(SETTINGS.MQTT_WSS_URL,{clientId:'cells_'+Math.random().toString(16).slice(2)});
  client.on('connect',()=>{
    elMqtt.textContent='po≈ÇƒÖczono';
    // subskrypcje wszystkich 32 temat√≥w
    Object.keys(topicMap).forEach(tp => client.subscribe(tp));
  });
  client.on('reconnect',()=> elMqtt.textContent='ponowne ≈ÇƒÖczenie‚Ä¶');
  client.on('close',()=> elMqtt.textContent='roz≈ÇƒÖczono');
  client.on('error',e=>{ elMqtt.textContent='b≈ÇƒÖd MQTT (konsola)'; console.error(e); });

  client.on('message',(topic,payload)=>{
    const nodeId = topicMap[topic];
    if(!nodeId) return;
    const val = parseNum(payload.toString());
    nodes[nodeId].el.textContent = fmt(val, 3);
  });
}
</script>
</body>
</html>
